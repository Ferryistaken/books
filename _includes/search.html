<style>
    @import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&display=swap');

    #searchModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
        animation: fadeIn 0.15s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    #searchModalContent {
        background: #fff;
        margin: 10vh auto 0;
        padding: 0;
        max-width: 640px;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        overflow: hidden;
    }

    #searchModalHeader {
        display: flex;
        align-items: center;
        padding: 1rem 1rem 0.75rem;
        border-bottom: 1px solid #e8e8e8;
    }

    #searchModalTitle {
        font-size: 0.8125rem;
        color: #666;
        margin: 0;
        flex: 1;
        font-weight: 500;
        letter-spacing: 0.02em;
        text-transform: uppercase;
    }

    #closeSearchModal {
        border: none;
        background: none;
        color: #999;
        cursor: pointer;
        padding: 0.25rem;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        line-height: 1;
        border-radius: 4px;
        transition: all 0.15s ease;
    }

    #closeSearchModal:hover {
        background: #f5f5f5;
        color: #333;
    }

    #searchInputWrapper {
        padding: 0.75rem 1rem;
        display: flex;
        gap: 0.5rem;
    }

    #searchQuery {
        flex: 1;
        padding: 0.625rem 0.875rem;
        font-size: 0.9375rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        border: 1px solid #e0e0e0;
        background: #fafafa;
        color: #333;
        border-radius: 6px;
        transition: all 0.15s ease;
    }

    #searchQuery:focus {
        outline: none;
        border-color: #2b5e49;
        background: #fff;
    }

    #searchQuery::placeholder {
        color: #aaa;
    }

    #searchButton {
        padding: 0.625rem 1.25rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        background: #2b5e49;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
    }

    #searchButton:hover {
        background: #1f4537;
        transform: translateY(-1px);
    }

    #searchButton:active {
        transform: translateY(0);
    }

    #searchButton:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    #searchStatus {
        padding: 1rem;
        color: #666;
        font-size: 0.875rem;
        text-align: center;
        display: none;
    }

    #searchResults {
        max-height: 50vh;
        overflow-y: auto;
    }

    .search-result {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.15s ease;
        cursor: pointer;
    }

    .search-result:hover {
        background: #fafafa;
    }

    .search-result:last-child {
        border-bottom: none;
    }

    .search-result-text {
        font-size: 0.9375rem;
        line-height: 1.5;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .search-result-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        font-size: 0.8125rem;
    }

    .search-result-title {
        color: #666;
    }

    .search-result-similarity {
        font-family: 'SF Mono', Monaco, monospace;
        color: #999;
        font-size: 0.75rem;
    }

    .search-result-link {
        color: #2b5e49 !important;
        text-decoration: none;
        font-weight: 500;
        margin-left: auto;
        font-size: 0.8125rem;
        transition: color 0.15s ease;
    }

    .search-result-link:hover {
        color: #1f4537 !important;
    }

    #openSearchModal {
        border: none;
        background: none;
        cursor: pointer;
        padding: 0;
        margin: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s ease;
        vertical-align: middle;
        max-width: 12%;
    }

    #openSearchModal:hover {
        opacity: 0.7;
    }

    #openSearchModal svg {
        transform: translateY(4px);
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #e0e0e0;
        border-top-color: #2b5e49;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 0.375rem;
        vertical-align: text-bottom;
    }
</style>

<div id="searchModal">
    <div id="searchModalContent">
        <div id="searchModalHeader">
            <span id="searchModalTitle">Search</span>
            <button id="closeSearchModal" aria-label="Close">&times;</button>
        </div>

        <div id="searchInputWrapper">
            <input
                type="text"
                id="searchQuery"
                placeholder="Search highlights..."
                autocomplete="off"
            >
            <button id="searchButton">Search</button>
        </div>

        <div id="searchStatus"></div>
        <div id="searchResults"></div>
    </div>
</div>

<!-- Trigger/Open The Modal -->
<button id="openSearchModal" aria-label="Open search">
    <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
</button>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('searchModal');
        const openBtn = document.getElementById('openSearchModal');
        const closeBtn = document.getElementById('closeSearchModal');
        const searchBtn = document.getElementById('searchButton');
        const searchInput = document.getElementById('searchQuery');

        console.log('Search elements:', { modal, openBtn, closeBtn, searchBtn, searchInput });

        if (!modal || !openBtn || !closeBtn || !searchBtn || !searchInput) {
            console.error('Search: Missing required elements!');
            return;
        }

        openBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Opening search modal');
            modal.style.display = 'block';
            setTimeout(() => searchInput.focus(), 100);
        });

        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'block') {
                modal.style.display = 'none';
            }
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        if (searchBtn) {
            searchBtn.addEventListener('click', performSearch);
        }

        if (searchInput) {
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
    });

    function performSearch() {
        const query = document.getElementById('searchQuery').value.trim();
        const statusDiv = document.getElementById('searchStatus');
        const resultsDiv = document.getElementById('searchResults');
        const searchBtn = document.getElementById('searchButton');

        if (!query) {
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'Please enter a search query.';
            resultsDiv.innerHTML = '';
            return;
        }

        searchBtn.disabled = true;
        searchBtn.innerHTML = '<span class="loading-spinner"></span>Searching...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<span class="loading-spinner"></span>Searching through your highlights...';
        resultsDiv.innerHTML = '';

        const searchUrl = '{{ site.url }}/.netlify/functions/search?q=' + encodeURIComponent(query);

        fetch(searchUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Search failed');
                }
                return response.json();
            })
            .then(data => {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
                displayResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '❌ Search failed. Please try again.';
                resultsDiv.innerHTML = '';
            });
    }

    function displayResults(results) {
        const statusDiv = document.getElementById('searchStatus');
        const resultsDiv = document.getElementById('searchResults');

        if (!results || results.length === 0) {
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'No results found. Try a different query.';
            resultsDiv.innerHTML = '';
            return;
        }

        statusDiv.style.display = 'none';
        resultsDiv.innerHTML = '';

        results.forEach(result => {
            const resultEl = document.createElement('div');
            resultEl.className = 'search-result';

            const textEl = document.createElement('div');
            textEl.className = 'search-result-text';
            textEl.textContent = result.sentence;

            const metaEl = document.createElement('div');
            metaEl.className = 'search-result-meta';

            const titleEl = document.createElement('span');
            titleEl.className = 'search-result-title';
            titleEl.textContent = result.title;

            const similarityEl = document.createElement('span');
            similarityEl.className = 'search-result-similarity';
            similarityEl.textContent = `[${result.similarity.toFixed(2)}]`;

            const linkEl = document.createElement('a');
            linkEl.className = 'search-result-link';
            linkEl.href = '{{ site.url }}/books/' + result.isbn + '#' + result.index;
            linkEl.textContent = 'View highlight →';
            linkEl.target = '_blank';

            metaEl.appendChild(titleEl);
            metaEl.appendChild(similarityEl);
            metaEl.appendChild(linkEl);

            resultEl.appendChild(textEl);
            resultEl.appendChild(metaEl);
            resultsDiv.appendChild(resultEl);
        });
    }
</script>
